name: Check security.txt

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  check-securitytxt:
    runs-on: ubuntu-latest
    steps:
      - name: Check security.txt health
        id: check
        run: |
          URL="https://vizxglobal.com/.well-known/security.txt"
          echo "Checking $URL..."

          RESPONSE=$(curl -s -w "%{http_code}" -o security.txt "$URL")
          echo "HTTP Status: $RESPONSE"

          if [ "$RESPONSE" != "200" ]; then
            echo "::set-output name=reason::security.txt not reachable (HTTP $RESPONSE)"
            echo "fail=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          CONTACT_LINES=$(grep -c "^Contact:" security.txt || true)
          if [ "$CONTACT_LINES" -eq 0 ]; then
            echo "::set-output name=reason::Missing Contact line"
            echo "fail=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          EXPIRES=$(grep "^Expires:" security.txt | cut -d' ' -f2)
          if [ -n "$EXPIRES" ]; then
            if date --date="$EXPIRES" +%s >/dev/null 2>&1; then
              NOW=$(date +%s)
              EXP_TS=$(date --date="$EXPIRES" +%s)
              if [ "$EXP_TS" -le "$NOW" ]; then
                echo "::set-output name=reason::Expired Expires field"
                echo "fail=true" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              echo "::set-output name=reason::Unparsable Expires field"
              echo "fail=true" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo "::set-output name=reason::OK"
          echo "fail=false" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue on failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ðŸš¨ Broken security.txt detected"
          content-file: ./security.txt-issue.md
          labels: bug, security

      - name: Generate issue content
        if: failure()
        run: |
          echo "A problem was detected with the public security.txt file at https://vizxglobal.com/.well-known/security.txt" > security.txt-issue.md
          echo "" >> security.txt-issue.md
          echo "**Reason:** ${{ steps.check.outputs.reason }}" >> security.txt-issue.md
          echo "" >> security.txt-issue.md
          echo "This check failed automatically via GitHub Actions." >> security.txt-issue.md
